<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>雪峰博客</title><meta name="description" content="分享AI和云计算技术的最新动态与实践经验，以及其它有趣的话题。"><meta name="keywords" content="AI, GitHub Copilot, Azure云, 云计算, 前端技术, 后端技术, Web开发, 软件工程"><link rel="stylesheet" href="/assets/css/style.min.css"><link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.1.0/css/all.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/default.min.css"></head><body><nav class="navbar"><div class="nav-container"><div class="nav-logo"><h2><i class="fas fa-snowflake"></i> Snowpeak</h2></div><div class="nav-menu"><a href="/" class="nav-link">首页</a><a href="/zh/page_1.htm" class="nav-link">文章</a><a href="/#tools" class="nav-link">工具</a><a href="/zh/about.htm" class="nav-link">关于</a><a href="/en/" class="nav-link lang-switch"><i class="fas fa-globe"></i> English</a></div><div class="nav-toggle" id="mobile-menu"><span class="bar"></span><span class="bar"></span><span class="bar"></span></div></div></nav><header class="article-header"><div class="container"><h1>和AI聊天，用Python画图 - ChatPyplot 介绍</h1><div class="article-meta"><span><i class="fas fa-calendar"></i> 发布时间: 2025-10-17 15:20:00</span><span><i class="fas fa-clock"></i> 阅读约需: 10 分钟 </span><span><i class="fas fa-tag"></i> 分类: 综合开发</span></div></div></header><main class="article-container"><h2>概述</h2><p>先上演示应用 <a href="https://www.snowpeak.org/math_question/ChatPyplot.htm">https://www.snowpeak.org/math_question/ChatPyplot.htm</a></p><p>演示运行的截图： <img alt="ChatPyplot运行截图" src="../assets/img/20251017_ChatPyplot.webp"></p><p>项目源码已开源 <a href="https://github.com/xfsnow/xfsnow.github.io/blob/master/math_question/ChatPyplot.htm">https://github.com/xfsnow/xfsnow.github.io/blob/master/math_question/ChatPyplot.htm</a></p><h3>谁适合看此文档？</h3><p>本文深入讲解了一个结合 Python Matplotlib 库与 AI 对话功能的智能工具——ChatPyplot 的开发过程和实现原理。适用于对前端开发、AI 集成和数据可视化感兴趣的朋友，了解 JavaScript、HTML/CSS 基本语法，有一定的前端开发经验。</p><h3>此文档有什么用？</h3><p>此文档介绍的内容适用于较大规模的前端开发项目，尤其是涉及 AI 集成、数据可视化和用户交互设计的场景。通过详细介绍 ChatPyplot 项目的架构和实现细节，帮助开发者理解如何将 AI 技术与 Python 数据可视化库结合，创造出实用的教育工具。</p><h3>意义</h3><p>在教育和数据分析领域，可视化是一个非常重要的工具。传统的数据可视化需要用户掌握特定的编程语言和库的使用方法，而将 AI 与 Python Matplotlib 结合可以大大降低使用门槛，使用户能够通过自然语言与系统交互，自动生成和执行绘图代码。这不仅提高了用户体验，也拓展了数据可视化的应用场景。</p><p>ChatPyplot 项目的意义在于： 1. 提供了一种全新的数据分析和可视化方式 2. 展示了如何将多种 AI 模型集成到一个统一的界面中 3. 实现了 AI 与 Python 数据可视化库的无缝连接 4. 为教育技术的发展提供了新的思路</p><h2>项目背景与需求场景</h2><h3>项目背景</h3><p>Python Matplotlib 是一款优秀的数据可视化库，广泛应用于数据分析和科研领域。然而，使用 Matplotlib 需要掌握其特定的 API 和编程语法，这对初学者来说是一个门槛。同时，随着 AI 技术的发展，特别是大语言模型在理解和生成代码方面的能力不断提升，将 AI 与 Python 数据可视化库结合成为可能。</p><p>ChatPyplot 项目应运而生，旨在通过自然语言交互降低 Python Matplotlib 的使用门槛，让用户能够通过简单的语言描述来生成和执行绘图代码。</p><h3>解决的需求场景</h3><ol><li><strong>降低学习门槛</strong>：用户无需掌握复杂的 Python 和 Matplotlib 语法，只需用自然语言描述需求</li><li><strong>提高效率</strong>：快速生成和执行绘图代码，节省手动编写时间</li><li><strong>多模型支持</strong>：集成多种 AI 模型，满足不同用户的需求</li><li><strong>图像理解</strong>：支持上传图片，结合图像内容进行分析和绘图</li><li><strong>教育应用</strong>：为数据分析教学和学习提供直观的可视化工具</li></ol><h2>代码架构设计</h2><h3>整体架构</h3><p>ChatPyplot 项目采用纯前端架构，主要由以下几个部分组成：</p><ol><li><strong>用户界面层</strong>：HTML/CSS 实现的用户界面</li><li><strong>控制逻辑层</strong>：JavaScript 实现的业务逻辑</li><li><strong>AI 接口层</strong>：与不同 AI 模型的接口实现</li><li><strong>Python 运行环境层</strong>：Pyodide 运行环境，用于在浏览器中执行 Python 代码</li></ol><h3>核心类设计</h3><p>项目采用了面向对象的设计方法，主要包含以下几个核心类：</p><h4>AiBase 基类</h4><p>AiBase 是所有 AI 模型类的基类，封装了通用的逻辑，包括： - 消息历史管理 - 系统提示语处理 - 图片文件转 Base64 编码 - AI 响应格式化 - Python 代码提取</p><h4>具体 AI 模型类</h4><p>项目支持三种主要的 AI 模型，每种模型都有对应的实现类，继承自 AiBase 基类：</p><ol><li><strong>AiDeepSeek</strong> - DeepSeek AI 类</li><li><strong>AiQwen</strong> - 通义千问 AI 类</li><li><strong>AiAzureOpenAI</strong> - Azure OpenAI AI 类</li></ol><p>每个子类根据各自模型的 API 规范实现了特定的调用逻辑。</p><h4>PyodideManager 类</h4><p>这是项目的核心管理类，负责在浏览器中运行 Python 代码，主要功能包括： - 初始化 Pyodide 运行环境 - 加载必要的 Python 包（如 numpy、matplotlib） - 加载并配置中文字体 - 执行 Python 代码并生成图像 - 管理 Python 环境状态</p><h2>Pyodide 在浏览器中运行的基本原理</h2><h3>什么是 Pyodide？</h3><p>Pyodide 是一个 Python 发行版，它被编译为 WebAssembly 并在浏览器中运行。它使得在浏览器中直接运行 Python 代码成为可能，无需服务器端支持。</p><h3>工作原理</h3><ol><li><p><strong>加载 Pyodide</strong>：首次访问时，浏览器会从 CDN 下载 Pyodide 环境（约 10-20MB），其中包括 Python 解释器和标准库。</p></li><li><p><strong>安装依赖包</strong>：根据需要加载额外的 Python 包，如 numpy、matplotlib 等科学计算库。这些包也被编译为 WebAssembly 格式。</p></li><li><p><strong>执行 Python 代码</strong>：用户生成的 Python 代码在浏览器中的 Pyodide 环境中执行，无需与服务器通信。</p></li><li><p><strong>结果可视化</strong>：使用 Matplotlib 生成的图表被转换为图像数据（base64 编码），然后显示在网页上。</p></li></ol><h3>技术优势</h3><ul><li><strong>隐私保护</strong>：所有代码都在本地浏览器中执行，无需上传到服务器</li><li><strong>实时响应</strong>：无需网络往返，代码执行响应速度快</li><li><strong>离线可用</strong>：一旦加载完成，即使断网也能继续使用</li><li><strong>丰富的生态系统</strong>：支持大多数常用的 Python 科学计算库</li></ul><h2>中文字体加载与显示方案</h2><h3>问题背景</h3><p>在数据可视化中，正确显示中文标签、标题和图例是一个重要需求。然而，浏览器中的 Pyodide 环境无法访问系统字体，因此需要特殊处理才能正确显示中文。</p><h3>解决方案</h3><p>ChatPyplot 采用了一种有效的中文字体加载和配置方案：</p><ol><li><p><strong>字体文件获取</strong>：从 Google Fonts CDN 获取思源黑体（Noto Sans SC）字体文件。</p></li><li><p><strong>字体文件加载</strong>：使用 fetch API 下载字体文件，并将其写入 Pyodide 的虚拟文件系统中。</p></li><li><p><strong>字体注册</strong>：在 Python 环境中使用 matplotlib 的字体管理功能注册并加载中文字体。</p></li><li><p><strong>字体配置</strong>：设置 matplotlib 的默认字体为加载的中文字体。</p></li></ol><h3>实现细节</h3> <pre><code class="language-javascript">// 加载字体文件
const fontResponse = await fetch(this.fontUrl);
if (fontResponse.ok) {
  const fontArrayBuffer = await fontResponse.arrayBuffer();
  const fontData = new Uint8Array(fontArrayBuffer);
  this.pyodide.FS.writeFile(fontPath, fontData);
}

// 在 Python 环境中配置字体
this.pyodide.runPython(`
try:
    # 检查字体文件是否存在于Pyodide的虚拟文件系统中
    if os.path.exists('${fontPath}'):
        # 加载字体文件
        fm.fontManager.addfont('${fontPath}')
        font_name = fm.FontProperties(fname='${fontPath}').get_name()
        # 设置为默认字体
        plt.rcParams['font.family'] = font_name
except Exception as e:
    # 备用字体方案
    plt.rcParams['font.sans-serif'] = ['DejaVu Sans', 'Bitstream Vera Sans', 'Arial Unicode MS', 'sans-serif']
`);
</code></pre> <h3>技术要点</h3><ul><li>使用思源黑体（Noto Sans SC）作为主要中文字体，它是一款开源、高质量的字体</li><li>通过 Pyodide 的 FS 模块将字体文件写入虚拟文件系统</li><li>使用 matplotlib 的 fontManager 注册字体</li><li>设置合理的字体回退机制，确保在字体加载失败时仍能显示基本内容</li><li>配置负号显示，解决中文负号显示异常问题</li></ul><h2>系统提示语设计</h2><p>系统提示语是引导 AI 行为的关键部分，在 ChatPyplot 项目中具有特殊的重要性。它不仅需要指导 AI 如何回答数学相关问题，还需要明确如何生成 Python 代码。</p><h3>系统提示语的核心内容</h3><p>系统提示语主要包括以下几个方面：</p><ol><li><strong>角色定义</strong>：明确 AI 作为数据可视化助手的身份</li><li><strong>行为规范</strong>：要求 AI 在回答时提供友好的解释和清晰的 Python 代码</li><li><strong>代码格式</strong>：规定 Python 代码必须放在特定的代码块中（<code>python</code>）</li><li><strong>数学公式格式</strong>：要求数学公式使用 $$ 包裹</li><li><strong>代码规范</strong>：生成的代码应能直接运行并生成可视化图表</li></ol><h3>系统提示语的共享机制</h3><p>在 ChatPyplot 中，系统提示语作为全局配置，对所有 AI 模型都有效。用户只需设置一次，即可应用于所有模型，这大大简化了配置过程。</p><h2>对话交互方式</h2><p>ChatPyplot 支持多种对话交互方式，满足不同场景的需求：</p><h3>纯文本对话</h3><p>用户可以直接输入文本问题，如"画一个正弦函数图像"，AI 会解析问题并生成相应的 Python 代码。</p><h3>文本加图片对话</h3><p>对于更复杂的场景，用户可以上传图片并结合文本描述进行提问。这特别适用于以下场景： - 上传数据图表图片，询问数据分析方法并重新绘制 - 上传函数图像，要求分析函数性质并绘制相似图形 - 上传实际场景照片，要求抽象为数据模型并绘制</p><p>这一功能主要由支持视觉理解的模型实现，如 Azure OpenAI 的 gpt-4o 和通义千问的 qwen3-vl-plus。</p><h2>图片处理与接口调用</h2><h3>本地图片处理流程</h3><p>当用户选择上传图片时，系统会执行以下步骤：</p><ol><li><strong>文件选择</strong>：用户通过文件选择器选择本地图片</li><li><strong>格式校验</strong>：检查文件类型（JPG/PNG/GIF/WEBP）和大小（不超过10MB）</li><li><strong>转换编码</strong>：使用 FileReader 将图片文件转换为 Base64 编码</li><li><strong>预览显示</strong>：在界面中显示图片预览</li><li><strong>数据存储</strong>：将 Base64 编码存储在共享状态中</li></ol><h3>图片参数组织</h3><p>在调用支持视觉理解的 AI 模型时，需要将图片和文本组织成特定的参数格式：</p> <pre><code class="language-javascript">// 构造包含图片和文本的用户消息
const userContent = [
  { type: &quot;text&quot;, text: &quot;请分析这张图片中的数据图表并重新绘制&quot; },
  { 
    type: &quot;image_url&quot;, 
    image_url: {
      url: &quot;data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...&quot;
    }
  }
];
</code></pre> <p>这种结构化的方式允许 AI 同时处理文本和图像信息，提供更丰富的交互体验。</p><h2>调用大模型的主要原理</h2><h3>统一接口设计</h3><p>项目通过继承 AiBase 基类，为不同的 AI 模型实现了统一的接口。这样做的好处是： 1. 代码结构清晰，易于维护和扩展 2. 新增 AI 模型只需继承基类并实现特定方法 3. 上层调用逻辑无需关心具体模型的实现细节</p><h3>流式传输处理</h3><p>为了提供更好的用户体验，项目采用了流式传输技术，实时显示 AI 的思考过程。这种方式让用户能够看到 AI 逐步生成的响应，而不是等待完整响应后再显示。</p><h3>多模型支持机制</h3><p>项目通过模型选择机制支持多种 AI 模型，用户可以根据需求选择合适的模型。每种模型都有独立的配置项，但共享系统提示语等全局设置。</p><h2>项目特点与优势</h2><h3>多模型支持</h3><p>ChatPyplot 支持多种主流 AI 模型：</p><ol><li><strong>DeepSeek</strong>：适合中文场景的开源大模型</li><li><strong>通义千问</strong>：阿里巴巴的千问系列模型，支持图像理解</li><li><strong>Azure OpenAI</strong>：微软 Azure 平台的 OpenAI 服务</li></ol><h3>图像理解能力</h3><p>项目支持上传图片并与 AI 进行结合分析，这是通过 Azure OpenAI 的 gpt-4o 模型和通义千问的 qwen3-vl-plus 模型实现的。这些模型具备强大的视觉理解能力，能够分析图片中的数据内容并生成相应的 Python 代码。</p><h3>本地存储配置</h3><p>用户的配置信息通过 localStorage 进行持久化存储，包括各模型的 API 密钥和系统提示语等。这样用户在下次访问时无需重新配置。</p><h3>浏览器内代码执行</h3><p>与传统的需要服务器执行代码的方案不同，ChatPyplot 使用 Pyodide 在浏览器中直接执行 Python 代码，具有更好的隐私保护和响应速度。</p><h3>中文支持完善</h3><p>通过精心设计的中文字体加载和配置方案，确保图表中的中文标签、标题和图例能够正确显示。</p><h2>总结</h2><p>ChatPyplot 项目通过将 AI 技术与 Python Matplotlib 库相结合，为用户提供了一种全新的数据分析和可视化方式。项目采用模块化设计，具有良好的扩展性和维护性，支持多种 AI 模型和图像理解功能。</p><p>通过这个项目，我们可以看到：</p><ol><li>AI 技术在数据分析领域的巨大潜力</li><li>前端技术在实现复杂交互方面的强大能力</li><li>WebAssembly 技术在浏览器中运行复杂应用的可能性</li><li>开源技术在推动教育创新中的重要作用</li></ol><p>未来，该项目还可以进一步扩展，例如：</p><ol><li>增加更多的 AI 模型支持</li><li>提供更丰富的可视化效果和图表类型</li><li>增强交互性和用户体验</li><li>和数据分析系统集成，实现数据的智能分析和可视化</li></ol></main><footer class="footer"><div class="container"><div class="footer-content"><div class="footer-section"><h3><i class="fas fa-snowflake"></i> Snowpeak</h3><p>分享AI和云计算技术的最新动态与实践经验，以及其它有趣的话题。</p><div class="social-links"><div class="social-platforms"><a href="https://github.com/xfsnow" target="_blank" class="social-link"><i class="fab fa-github"></i></a><a href="https://snowpeak.blog.csdn.net/" target="_blank" class="social-link"><i class="fas fa-blog"></i></a><a href="https://space.bilibili.com/701839928" target="_blank" class="social-link"><i class="fab fa-bilibili"></i></a><a href="https://www.linkedin.com/in/snowpeak" target="_blank" class="social-link"><i class="fab fa-linkedin"></i></a></div><div class="wechat-section"><div class="wechat-info"><span class="wechat-label">微信公众号</span><span class="wechat-name">技术温暖生活</span></div><img src="/assets/img/techwarm.jpg" alt="技术温暖生活" class="wechat-qr"></div></div></div><div class="footer-section"><h4>快速链接</h4><ul><li><a href="/#articles">文章</a></li><li><a href="/#tools">工具</a></li><li><a href="https://docs.github.com/en/pages" target="_blank">GitHub Pages</a></li></ul></div><div class="footer-section"><h4>技术栈</h4><ul><li>Python</li><li>GitHub Copilot</li><li>Claude Sonnet 4</li><li>HTML/CSS/JS</li><li>响应式设计</li></ul></div></div><div class="footer-bottom"><p>Copyright &copy; 2013-<script>document.write((new Date()).getFullYear());</script> 雪峰博客。运行在 GitHub Pages 上。 <a href="https://beian.miit.gov.cn" target="_blank" class="icp_beian">京ICP备2021007720号</a><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502052523" target="_blank" class="gongan_beian">京公网安备11010502052523号</a></p></div></div></footer><script src="/zh/index.js"></script><script src="/assets/js/blog.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script><script>hljs.highlightAll(); if (window.location.hostname === 'www.snowpeak.org') { const script = document.createElement('script'); script.defer = true; script.src = 'https://static.cloudflareinsights.com/beacon.min.js'; script.dataset.cfBeacon = JSON.stringify({ "token": "4c2c021185e64942857a36d116eb4711" }); document.head.appendChild(script); } </script></body></html>