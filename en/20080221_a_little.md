# A Little Lottery Made with JavaScript

Published: *2008-02-21 14:37:00*

Category: __Frontend__

---------

## Task

Before the Spring Festival, the company held a party with a lottery segment. The lottery consists of several rounds, each drawing a different number of people, and those who are drawn do not participate in subsequent lotteries.

## Analysis

Since development was done on my own computer, but at the party site it needed to be placed on a dedicated machine connected to a projector, cross-platform compatibility was required. Employee data for the party might be adjusted frequently until the day of the event, so it was also necessary to easily interface with employee source data. Eventually, JavaScript was chosen as a purely client-side language that can run with just IE, and the display effects can be fully supported by CSS, allowing for a beautiful interface.

## Environment

IE 6+

## Solution

Employee data is stored separately in a text file and read using IE's Scripting.FileSystemObject;

Employee data needs to display three items: ID, name, and department name, so the text file is saved as tab-delimited data from Excel, and JavaScript is used to output it as a table;
Since it's for projection display, it's all made keyboard-controlled, capturing key events with document.onkeypress;
For random array sorting, JavaScript has a very convenient built-in method: array.sort(function(){return Math.random()>0.5?-1:1;});

## Code

employ.txt

External data for employees are like following:
```
12009 name1 department1
15971 name2 department2
7815 name3 department3
9483 name4 department4
9507 name5 department5
10589 name6 department6
17212 name7 department7
15487 name8 department8
14934 name9 department9
```

## Page

lottery.htm

```html
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf8" />
<title>Lottery</title>
<style type="text/css">
   body {
   overflow: hidden;
   background-image: url(bg.jpg);
   background-repeat: no-repeat;
   font-family: Arial, sans-serif;
   }
   h1 {
   margin-top: 130px;
   font-size: 40px;
   color: #FF0000;
   }
   #showlot {
   font-size: 30px;
   font-weight: bold;
   color: #FF0000;
   }
   #showlot td {
   width: 200px;
   }
</style>
<script type="text/javascript">
</script>
</head>
<body>
<h1 align="center">Good luck for your fortune</h1>
<div id="showlot"></div>
<script language="JavaScript" type="text/javascript">
   // Check if an element exists in the array
   function inArray(arr,key)
   {
       re = new RegExp(key,[""]);
       return (arr.toString().replace(re,"┢").replace(/[^,┢]/g,"")).indexOf("┢");
   }
   
   // JavaScript implementation of a small lottery program. Read data from an external text file into an array,
   // randomly sort the array and display it in input fields with CSS-styled borders removed,
   // controlled by buttons to start and stop, with each cycle restarting from the beginning after reaching the end of the array.
   // Since setInterval is used to control the function, mostly global variables are used.
   var fso, ts, str;
   var arrayUser = new Array();
   // Record the number of people drawn in each batch in an array
   var arrayBatch = new Array(10, 10, 10, 10, 10, 10, 10, 10,10, 10, 10, 10, 4, 2, 1, 1, 1, 1, 1, 1, 1);
   var indexBatch = 0;
   var ForReading = 1;
   // Physical path to the text file - double backslashes are required because JavaScript uses / as an escape character, so // represents /.
   str = 'D://lucky//employ.txt';
   fso = new ActiveXObject("Scripting.FileSystemObject");
   ts = fso.OpenTextFile(str, ForReading);
   var i = 0;
   // Read file content line by line into the array
   while (!ts.AtEndOfStream)
   {
       arrayUser[i++] = ts.ReadLine();
   }
   // Close the file
   ts.Close();
   // Initially shuffle the array
   arrayUser.sort(function(){return Math.random()>0.5?-1:1;});

   // Timer is a pointer variable to control the loop. The actual shuffling is of array elements, 
   // meaning the array is reshuffled each cycle, causing the corresponding keys to be reshuffled! 
   // Time always goes from 0 to array length.
   timer = 0;
   str = "";
   var arrayLine = new Array();
   var arrayNow = new Array();
   function lottery()
   {
       // When the remaining array elements are not enough for this batch, restart from the beginning 
       // (this makes the last few people in each round have slightly fewer chances), 
       // reshuffling each time when restarting. Need to use >= for comparison.
       if (timer >= (arrayUser.length-arrayBatch[indexBatch]) )
       {
           timer = 0;
           // Let the sort comparison function randomly return -1 or 1. 
           // For other sorting methods, other comparison functions can be used,
           // http://webuc.net/dotey/archive/2004/12/06/2354.aspx and http://blog.iyi.cn/hily/archives/2005/09/javascript.html
           arrayUser.sort(function(){return Math.random()>0.5?-1:1;});
       }
       else
       {
           str="";
           arrayNow = new Array();
           for (i = 0; i < arrayBatch[indexBatch]; i++)
           {
               arrayLine = arrayUser[timer].split("/t");//arrayUser[0][0] is employee ID, arrayUser[0][1] is name, arrayUser[0][2] is department
               arrayNow[i] = arrayUser[timer]; // Record the current winner being displayed
               str+="<tr><td>"+arrayLine[0]+"</td><td>"+arrayLine[1]+"</td><td>"+arrayLine[2]+"</td></tr>";
               timer++;
           }
           str = '<table align="center">'+str+'</table>';
           document.getElementById("showlot").innerHTML = str;
       }
   }
   
   // Larger numbers mean slower speed
   var speed=50;
   // Record the winners
   var winIndex = 0;
   var arrayWin = new Array();
   document.onkeypress=function()
   {
       // c key is 99, clear display; p key is 112, start; s key is 115, stop.
       if (window.event.keyCode == 99)
       {
           // Since each batch has a different number of people, clear the current batch display 
           // to prevent the last few people from previous batches with more people from always showing in the back slots
           for (i = 0; i < 10; i++)
           {
               str= "";
               document.getElementById("showlot").innerHTML ="";
           }
       }
       else if (window.event.keyCode == 112)
       {
           // Since each batch has a different number of people, clear the current batch display 
           // to prevent the last few people from previous batches with more people from always showing in the back slots
           for (i = 0; i < 10; i++)
           {
               str= "";
               document.getElementById("showlot").innerHTML ="";
           }
           MyMar=setInterval(lottery, speed);
       }
       else if (window.event.keyCode == 115)
       {
           // Stop running first
           clearInterval(MyMar);
           // Record the current winners into the overall winner array.
           // This could be simplified to remove current winners from the overall user array each time it stops,
           // but recording in the overall winner array now is convenient for future expansion to display all winners at the end.
           for (i = 0; i < arrayBatch[indexBatch]; i++)
           {
               arrayWin[winIndex] = arrayNow[i];
               winIndex++;
           }
           // JavaScript doesn't have a built-in function to remove array elements. 
           // Since the array is shuffled each time, the array keys are unpredictable,
           // so it's easier to loop through and remove the values of the drawn people by value comparison.
           // Loop once, skip when encountering the value of a drawn person, and record the rest.
           var j = 0;
           var arrayNextpool = new Array();
           for (i=0; i< arrayUser.length; i++)
           {
               // Remove winners from the overall list
               if (inArray(arrayWin, arrayUser[i]) >= 0)
               {
                   continue;
               }
               else
                   arrayNextpool[j++] = arrayUser[i];
           }
           arrayUser = arrayNextpool;
           indexBatch++;// Move to the next batch
           timer = 0; // After stopping, prepare to restart the cycle
       }
   }
</script>
</body>
</html>





---
*Original link: https://www.snowpeak.fun/en/article/detail/a_little_lottery_made_with_javascript/*