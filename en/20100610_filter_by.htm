<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Snowpeak Blog</title><meta name="description" content="Sharing and discussing cutting-edge technologies of AI and cloud computing, and other interesting topics."><meta name="keywords" content="AI, GitHub Copilot, Azure Cloud, Cloud Computing, Front-end Technology, Back-end Technology, Web Development, Software Engineering"><link rel="stylesheet" href="/assets/css/style.min.css"><link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.7.2/css/all.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/default.min.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script></head><body><nav class="navbar"><div class="nav-container"><div class="nav-logo"><h2><i class="fas fa-snowflake"></i> Snowpeak</h2></div><div class="nav-menu"><a href="/en/" class="nav-link">Home</a><a href="/en/page_1.htm" class="nav-link">Article</a><a href="/en#tools" class="nav-link">Tools</a><a href="/en/about.htm" class="nav-link">About</a><a href="/" class="nav-link lang-switch"><i class="fas fa-globe"></i> 简体中文</a></div><div class="nav-toggle" id="mobile-menu"><span class="bar"></span><span class="bar"></span><span class="bar"></span></div></div></nav><header class="article-header"><div class="container"><h1>Filter by Subset with Bit Operation</h1><div class="article-meta"><span><i class="fas fa-calendar"></i> Published: 2010-06-10 18:09:00</span><span><i class="fas fa-clock"></i> Reading time: 9 minutes </span><span><i class="fas fa-tag"></i> Category: Database</span></div></div></header><main class="article-container"><h2>Introduction</h2><p>Recently, while working on user permission control, I encountered a requirement that can be abstracted as follows: user's city attribute consists of multiple cities, and we need to list users whose city attributes are subsets of a given city set.</p><p>The initial user-city relationship table has sample data like below, with the first column being the user ID and the second column being the city:</p> <pre><code>1 anshan
1 beijing
1 baotou
1 baoding
1 beihai
1 baoji
1 chongqing
1 chengdu
2 anshan
2 beijing
3 baotou
3 baoding
3 beihai
4 baoji
4 shanghai
</code></pre> <p>For example, given a city set [anshan, beijing, baotou, baoding, beihai, baoji], we need to filter out users whose city attributes are subsets of this set. This means users whose cities are anshan or beijing, etc., but do not contain cities outside this set. For instance, user 2 has cities anshan and beijing, and user 3 has cities baotou, baoding, and beihai, both of which meet the criteria. User 4, although having baoji, also has shanghai, which is a city outside the specified set, so it does not meet the criteria.</p><h2>Implementation Principle</h2><p>After testing, bit operations can be used. First, separate the cities into a separate table, with city IDs represented in binary numbers. Each city sets a different bit to 1, meaning city IDs are powers of 2:</p> <pre><code>000000001 anshan
000000010 beijing
000000100 baotou
000001000 baoding
000010000 beihai
000100000 baoji
001000000 chongqing
010000000 chengdu
100000000 shanghai
</code></pre> <p>Then, the user-city relationship is changed to the sum of city IDs for all cities of a user:</p><table><thead><tr><th>ID</th><th>Binary</th></tr></thead><tbody><tr><td>1</td><td>000111111</td></tr><tr><td>2</td><td>000000011</td></tr><tr><td>3</td><td>000011100</td></tr><tr><td>4</td><td>100100000</td></tr><tr><td>5</td><td>110000001</td></tr></tbody></table><p>Here, the set [anshan, beijing, baotou, baoding, beihai, baoji] can be represented as 111111. During filtering, users whose bitwise AND result with the current user equals the user value itself are considered matching.</p><h2>Usage</h2><p>In the above demonstration data, integers are represented in binary. In actual database storage, they are stored as decimal numbers. The following is a specific SQL statement example for filtering users with city set 111111, where 111111 has been converted to decimal number 63:</p> <pre><code class="language-sql">select user_id, city_sum from user_city where (city_sum &amp; 63)=city_sum;
</code></pre> <p>In this solution, city IDs are powers of 2, which requires a large field length. The maximum value for MySQL unsigned BIGINT is 18446744073709551615. Therefore, both city IDs and users' city attributes use unsigned BIGINT.</p><p>Finally, here are the actual SQL statements that can be used in this example. This is for MySQL database, and other databases can be inferred accordingly:</p> <pre><code class="language-sql">CREATE TABLE `city` (
  `city_id` bigint(20) unsigned NOT NULL default '0',
  `city_name` varchar(20) NOT NULL,
  PRIMARY KEY  (`city_id`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COMMENT='City, city ID is a binary number incremented by bit';

INSERT INTO `city` VALUES (1, 'anshan');
INSERT INTO `city` VALUES (2, 'beijing');
INSERT INTO `city` VALUES (4, 'baotou');
INSERT INTO `city` VALUES (8, 'baoding');
INSERT INTO `city` VALUES (16, 'beihai');
INSERT INTO `city` VALUES (32, 'baoji');
INSERT INTO `city` VALUES (64, 'chongqing');
INSERT INTO `city` VALUES (128, 'chengdu');
INSERT INTO `city` VALUES (256, 'shanghai');

CREATE TABLE `user_city` (
  `user_id` int(11) NOT NULL,
  `city_sum` bigint(20) unsigned default '0',
  PRIMARY KEY  (`user_id`)
) ENGINE=MyISAM DEFAULT CHARSET=latin1 COMMENT='User-City Relationship';

INSERT INTO `user_city` VALUES (1, 63);
INSERT INTO `user_city` VALUES (2, 3);
INSERT INTO `user_city` VALUES (3, 28);
INSERT INTO `user_city` VALUES (4, 288);
INSERT INTO `user_city` VALUES (5, 385);
</code></pre> <hr><p><em>Original Link: https://www.snowpeak.fun/en/article/detail/filter_by_subset_with_bit_operation/</em></p></main><footer class="footer"><div class="container"><div class="footer-content"><div class="footer-section"><h3><i class="fas fa-snowflake"></i> Snowpeak</h3><p>Sharing and discussing cutting-edge technologies of AI and cloud computing, and other interesting topics.</p><div class="social-links"><div class="social-platforms"><a href="https://github.com/xfsnow" target="_blank" class="social-link"><i class="fab fa-github"></i></a><a href="https://snowpeak.blog.csdn.net/" target="_blank" class="social-link"><i class="fas fa-blog"></i></a><a href="https://space.bilibili.com/701839928" target="_blank" class="social-link"><i class="fab fa-bilibili"></i></a><a href="https://www.linkedin.com/in/snowpeak" target="_blank" class="social-link"><i class="fab fa-linkedin"></i></a></div><div class="wechat-section"><div class="wechat-info"><span class="wechat-label">WeChat Account</span><span class="wechat-name">Tech Warm Life</span></div><img src="/assets/img/techwarm.jpg" alt="Tech Warm Life" class="wechat-qr"></div></div></div><div class="footer-section"><h4>Quick Links</h4><ul><li><a href="/#articles">Article</a></li><li><a href="/#tools">Tools</a></li><li><a href="https://docs.github.com/en/pages" target="_blank">GitHub Pages</a></li></ul></div><div class="footer-section"><h4>Tech Stack</h4><ul><li>Python</li><li>GitHub Copilot</li><li>Claude Sonnet 4</li><li>HTML/CSS/JS</li><li>Responsive Design</li></ul></div></div><div class="footer-bottom"><p>Copyright &copy; 2013-<script>document.write((new Date()).getFullYear());</script> Snowpeak Blog. Running on GitHub Pages. <a href="https://beian.miit.gov.cn" target="_blank" class="icp_beian">京ICP备2021007720号</a><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502052523" target="_blank" class="gongan_beian">京公网安备11010502052523号</a></p></div></div></footer><script src="/en/index.js"></script><script src="/assets/js/blog.min.js"></script><script>hljs.highlightAll();</script></body></html>