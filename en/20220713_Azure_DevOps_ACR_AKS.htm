<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Snowpeak Blog</title><meta name="description" content="Sharing and discussing cutting-edge technologies of AI and cloud computing, and other interesting topics."><meta name="keywords" content="AI, GitHub Copilot, Azure Cloud, Cloud Computing, Front-end Technology, Back-end Technology, Web Development, Software Engineering"><link rel="stylesheet" href="/assets/css/style.min.css"><link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.1.0/css/all.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/default.min.css"></head><body><nav class="navbar"><div class="nav-container"><div class="nav-logo"><h2><i class="fas fa-snowflake"></i> Snowpeak</h2></div><div class="nav-menu"><a href="/en/" class="nav-link">Home</a><a href="/en/page_1.htm" class="nav-link">Article</a><a href="/en#tools" class="nav-link">Tools</a><a href="/en/about.htm" class="nav-link">About</a><a href="/" class="nav-link lang-switch"><i class="fas fa-globe"></i> 简体中文</a></div><div class="nav-toggle" id="mobile-menu"><span class="bar"></span><span class="bar"></span><span class="bar"></span></div></div></nav><header class="article-header"><div class="container"><h1>Azure DevOps Comprehensive Management of ACR and AKS</h1><div class="article-meta"><span><i class="fas fa-calendar"></i> Published: 2022-07-13 10:00:00</span><span><i class="fas fa-clock"></i> Reading time: 16 minutes </span><span><i class="fas fa-tag"></i> Category: Azure</span></div></div></header><main class="article-container"><p>Azure DevOps is currently only available as a SaaS service in Microsoft's global Azure regions; it has not yet been released in the Azure China region. In fact, Azure DevOps can manage environments and platforms for various clouds and application deployments. Through Service Connections, it can easily connect to the Azure China region and other special Azure regions, such as US Government Cloud, Germany, etc. This article will guide you step by step to configure a subscription in the China region and establish a connection from Azure DevOps to the China region subscription.</p><h2>Managing CI Pipelines for Building to ACR</h2><h3>Configure ACR Service Connection</h3><p><a href="https://blog.yannickreekmans.be/bring-your-own-service-principal-for-an-azure-container-registry-connection-in-azure-devops/">https://blog.yannickreekmans.be/bring-your-own-service-principal-for-an-azure-container-registry-connection-in-azure-devops/</a></p><p>Add an "other" type of service connection and use the access key of the ACR in the China region for authentication.</p><p>My test user is currently a global administrator. By default, ordinary users cannot register applications. If you want ordinary users to be able to register applications, go to User Settings in the left navigation and enable the option for users to register applications.</p><h3>Create CI Pipeline</h3> <pre><code class="language-yaml">dockerRegistryServiceConnection: '44fbf17e-1870-4f48-9f1a-e57e81891048'
imageRepository: 'helloworld'
containerRegistry: 'snowpeak.azurecr.cn'
</code></pre> <p>The ID of the dockerRegistryServiceConnection service connection can be found in the browser address bar.</p><p><img alt="Graphical user interface, text, application, email Description automatically generated" src="../assets/img/20220713_Azure_DevOps_ACR_AKS_01.png"></p><p>containerRegistry: Go to the ACR overview page in the Azure portal.</p><p><img alt="Graphical user interface, text, application Description automatically generated" src="../assets/img/20220713_Azure_DevOps_ACR_AKS_10.png"></p><p><code>imageRepository: 'helloworld'</code></p><p>Find the image repository here.</p><p><img alt="Graphical user interface, application Description automatically generated" src="../assets/img/20220713_Azure_DevOps_ACR_AKS_11.png"></p><h3>Create Azure AD Service Principal</h3><p>In the portal, go back to Azure Active Directory, select "App registrations" in the left navigation, and then click "New registration".</p><p><img alt="Graphical user interface, text, application Description automatically generated" src="../assets/img/20220713_Azure_DevOps_ACR_AKS_12.png"></p><p>Give the application a name, such as "Azure-DevOps", and remember this name for later use.</p><p>Supported account types: select "Accounts in this organizational directory only", keep other settings as default.</p><p><img alt="Graphical user interface, text, application, email Description automatically generated" src="../assets/img/20220713_Azure_DevOps_ACR_AKS_13.png"></p><p>Finally, click Register to complete the registration.</p><h3>Add Authentication to the Service Principal</h3><p>To facilitate authentication when creating a service connection in Azure DevOps in the next step, we add authentication to the service principal just created. Here, we use the application secret method.</p><p>In Azure AD's "App registrations", select the application you just created. In the left navigation, select "Certificates &amp; secrets". Then, in the main pane, click "New client secret".</p><p><img alt="Graphical user interface, text, application Description automatically generated" src="../assets/img/20220713_Azure_DevOps_ACR_AKS_14.png"></p><p>In the pop-up, fill in the description, keep the expiration at the default 6 months, and click the Add button at the bottom. After adding successfully, the newly added record will be displayed.</p><p><img alt="Graphical user interface, text, application, email Description automatically generated" src="../assets/img/20220713_Azure_DevOps_ACR_AKS_15.png"></p><p>Note: Copy and save the Value immediately, as this is the only chance to do so. The Secret ID can be copied at any time.</p><h3>Assign a Role to the Application</h3><p>Go to the subscription management page in the portal, select the subscription you are working on, then click "Access control (IAM)" in the left navigation, click "Add" in the main pane, and then click "Add role assignment".</p><p><img alt="Graphical user interface, text, application, Word Description automatically generated" src="../assets/img/20220713_Azure_DevOps_ACR_AKS_16.png"></p><p>In the pop-up, select the role "Contributor", and for assignment, choose "User, group or service principal".</p><p>In the selection box, enter the application name you created earlier. A result will appear; click on it, and the Save button at the bottom left will become available.</p><p><img alt="Graphical user interface, text, application, email Description automatically generated" src="../assets/img/20220713_Azure_DevOps_ACR_AKS_17.png"></p><p>Finally, click Save. After success, you will return to the role assignment list, and the newly assigned role will be displayed, indicating the operation was successful.</p><h2>Configure AKS Service Connection</h2><h3>Create Azure DevOps Service Connection</h3><p>Log in to the Azure DevOps portal, enter your project, and go to Project settings in the lower left corner. Click Service connections under Pipelines, then click New service connection in the upper right corner. Step 1: Select Azure Resource Manager.</p><p><img alt="Graphical user interface, text, application, email Description automatically generated" src="../assets/img/20220713_Azure_DevOps_ACR_AKS_02.png"></p><p>Next, select Service principal (manual).</p><p>On this page, set Environment to Azure China Cloud.</p><p>Scope Level: select Subscription.</p><p>Subscription Id and Subscription Name: go back to the subscription overview page and copy the corresponding items from the main pane.</p><p><img alt="Graphical user interface, text, application Description automatically generated" src="../assets/img/20220713_Azure_DevOps_ACR_AKS_03.png"></p><p>Service Principal Id: Go to the subscription in the Azure China portal, open the application you just registered, and find the Application (client) ID on its overview page.</p><p><img alt="Graphical user interface, application Description automatically generated" src="../assets/img/20220713_Azure_DevOps_ACR_AKS_04.png"></p><p>Service principal key: Enter the Value from the client secret you saved earlier.</p><p>Tenant ID: Get this from the Directory (tenant) ID on the same page above. After filling in these five fields, the Verify button becomes available. Click it, and if successful, you will see a verification success message. If there is an error, please go back and check whether all IDs and secrets are filled in correctly.</p><p><img alt="Graphical user interface, text, application, email Description automatically generated" src="../assets/img/20220713_Azure_DevOps_ACR_AKS_05.png"></p><p>Finally, enter a meaningful name such as "Azure China" and a detailed description in Service connection name and Description (optional), then click Verify and save in the lower right corner to complete.</p><h2>Use Azure DevOps Release Pipeline to Verify Service Connection</h2><p>In the Azure DevOps portal, under Pipelines, click the New button in the middle of the main pane, then click New release pipeline.</p><p><img alt="Graphical user interface, application Description automatically generated" src="../assets/img/20220713_Azure_DevOps_ACR_AKS_06.png"></p><p>In the pop-up template selection, click the first Azure App Service deployment.</p><p><img alt="Graphical user interface, text, application Description automatically generated" src="../assets/img/20220713_Azure_DevOps_ACR_AKS_07.png"></p><p>In the next pop-up, click the "1 job, 1 task" link on the left.</p><p><img alt="Graphical user interface, text, application, email Description automatically generated" src="../assets/img/20220713_Azure_DevOps_ACR_AKS_08.png"></p><p>In the next pop-up, expand the menu under Azure subscription.</p><p><img alt="Graphical user interface, text, application Description automatically generated" src="../assets/img/20220713_Azure_DevOps_ACR_AKS_09.png"></p><p>You can see that the service connection we just created is already displayed here, indicating that the service connection was created successfully. Any subsequent release pipelines can use this service connection and select the specific resource target as prompted.</p></main><footer class="footer"><div class="container"><div class="footer-content"><div class="footer-section"><h3><i class="fas fa-snowflake"></i> Snowpeak</h3><p>Sharing and discussing cutting-edge technologies of AI and cloud computing, and other interesting topics.</p><div class="social-links"><div class="social-platforms"><a href="https://github.com/xfsnow" target="_blank" class="social-link"><i class="fab fa-github"></i></a><a href="https://snowpeak.blog.csdn.net/" target="_blank" class="social-link"><i class="fas fa-blog"></i></a><a href="https://space.bilibili.com/701839928" target="_blank" class="social-link"><i class="fab fa-bilibili"></i></a><a href="https://www.linkedin.com/in/snowpeak" target="_blank" class="social-link"><i class="fab fa-linkedin"></i></a></div><div class="wechat-section"><div class="wechat-info"><span class="wechat-label">WeChat Account</span><span class="wechat-name">Tech Warm Life</span></div><img src="/assets/img/techwarm.jpg" alt="Tech Warm Life" class="wechat-qr"></div></div></div><div class="footer-section"><h4>Quick Links</h4><ul><li><a href="/#articles">Article</a></li><li><a href="/#tools">Tools</a></li><li><a href="https://docs.github.com/en/pages" target="_blank">GitHub Pages</a></li></ul></div><div class="footer-section"><h4>Tech Stack</h4><ul><li>Python</li><li>GitHub Copilot</li><li>Claude Sonnet 4</li><li>HTML/CSS/JS</li><li>Responsive Design</li></ul></div></div><div class="footer-bottom"><p>Copyright &copy; 2013-<script>document.write((new Date()).getFullYear());</script> Snowpeak Blog. Running on GitHub Pages. <a href="https://beian.miit.gov.cn" target="_blank" class="icp_beian">京ICP备2021007720号</a><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502052523" target="_blank" class="gongan_beian">京公网安备11010502052523号</a></p></div></div></footer><script src="/en/index.js"></script><script src="/assets/js/blog.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script><script>hljs.highlightAll();</script></body></html>